import { stripIndent } from "common-tags";
import { FetchRpcHandler } from "../FetchRpcHandler";
import { StaticCatalogs } from "/imports/engine/StaticCatalogs";
import { ApplicationEntity } from "/imports/entities/manifest";
import { FetchRequestEntity, FetchResponseEntity } from "/imports/entities/protocol";

/**
 * # session.v1alpha1.dist.app
 *
 * This API is used by:
 *   - market (bundled app)
 *       This API provides the network and runtime access
 *       to explore the available applications and any existing installations.
 */
export async function serveMarketApi(rpc: {request: FetchRequestEntity['spec'], path: string, context: FetchRpcHandler }): Promise<FetchResponseEntity['spec']> {
  console.log('MARKET:', rpc);

  if (rpc.path == 'list-available-apps' && rpc.request.method == 'GET') {

    const bundledApps = Array.from(StaticCatalogs.entries()).map(([id, catalog]) => {
      const appRes: ApplicationEntity | undefined = catalog.flatMap(x => x.kind == 'Application' ? [x] : [])[0];
      // console.log({appRes});
      return {
        id: 'bundled:'+id.slice(4),
        // url: 'bundled:'+encodeURIComponent(id),
        url: `entity://bundled/manifest.dist.app@v1alpha1/Application/${encodeURIComponent(id)}`,
        title: appRes.metadata.title ?? 'N/A',
        description: appRes.metadata.description ?? 'N/A',
        iconUrl: iconUrls.get(id) ?? (appRes.spec.icon?.type == 'glyph'
        ? `data:image/svg+xml,${encodeURIComponent(stripIndent`
            <svg width="800" height="600" version="1.1" viewBox="0 0 80 60" xmlns="http://www.w3.org/2000/svg">
              <circle cx="40" cy="30" r="25" fill="${appRes.spec.icon.glyph.backgroundColor}" />
              <text x="40" y="1.5em" font-size="25" text-anchor="middle">${appRes.spec.icon.glyph.text}</text>
            </svg>`)}`
        : null),
        currentInstallations: [{
          profileNamespace: 'profile:guest',
          appInstallName: `bundledguestapp-${id}`,
        }],
      };
    });

    return {
      status: 200,
      headers: [
        ['content-type', 'application/json'],
      ],
      body: JSON.stringify({
        profiles: [{
          namespace: 'profile:user',
          title: 'Current user account',
        }, {
          namespace: 'profile:guest',
          title: 'Guest session',
        }],
        listings: [
          ...bundledApps,
          // TODO: other app sources
        ],
      }),
    };
  }

  return {
    status: 201,
    body: 'ok',
  };
}

const iconUrls = new Map<string,string>([
  ['app:scaleway', 'data:image/svg+xml,%3Csvg width="429.1" height="320.7" version="1.1" viewBox="0 0 429.1 320.7" xmlns="http://www.w3.org/2000/svg"%3E%3Cpath d="m395.5 230.3c-.4-.6-1.2-1-1.9-1h-5.4c-1 0-1.8.6-2.2 1.5l-11.2 28.9-10.6-28.9c-.4-.9-1.2-1.5-2.2-1.5h-6c-.8 0-1.5.4-1.9 1s-.5 1.5-.2 2.2l15.6 41.1c-.5 1.8-1.2 3.1-2.3 3.8-1.5 1-4.2 1.1-5.7 1.2-1.3.1-2.4 1.2-2.4 2.5v4c0 1.4 1.1 2.5 2.5 2.5 2.4 0 6.3.2 9.4-1.4 6.3-3.3 7.2-7.4 9-12.1l15.8-41.6c.2-.7.1-1.5-.3-2.2zm-163 29.3c-1.1-.8-2.6-.6-3.4.5-1 1.2-2.3 2.6-3.7 3.4-1.9 1-4.3 1.6-7.3 1.6-3.5 0-6.1-1.1-8.1-3.5-1.6-1.9-2.6-4.1-3.1-6.6h29.9c1.2 0 2.2-.9 2.3-2.1.1-.6.1-1.5.1-2.7 0-4.1-.9-7.9-2.7-11.2-1.8-3.4-4.4-6.1-7.6-8-3.2-2-6.9-3-10.9-3-4.2 0-8 1-11.3 3s-5.9 4.9-7.8 8.4c-1.8 3.5-2.8 7.6-2.8 12s.9 8.5 2.8 12c1.9 3.6 4.5 6.4 7.9 8.4 3.3 2 7.2 3 11.4 3 4.5 0 8.6-.9 11.9-2.8 3.5-1.9 5.7-4.3 7-6 .9-1.2.6-2.8-.6-3.7zm-21.8-18.9c1.9-1.9 4.3-2.8 7.4-2.8 3.2 0 5.6.8 7.4 2.5 1.3 1.2 2.3 3 2.9 5.2h-20.7c.6-1.9 1.6-3.5 3-4.9zm116.1 34.2c-4.2 0-8-1-11.4-3-3.3-2-6-4.9-7.9-8.4s-2.8-7.6-2.8-12.1c0-4.4.9-8.4 2.8-11.9s4.5-6.4 7.8-8.4 7.1-3 11.3-3c3.2 0 6.3.7 9 2.2.9.5 1.8 1 2.6 1.7v-.2c0-1.3 1-2.3 2.3-2.3h5.8c1.3 0 2.3 1 2.3 2.3v39.6c0 1.3-1 2.3-2.3 2.3h-5.8c-1.3 0-2.3-1-2.3-2.3v-.1c-.8.6-1.7 1.2-2.6 1.6-2.6 1.3-5.6 2-8.8 2zm-.1-37c-2.2 0-4.1.5-5.8 1.7-1.7 1.1-3.1 2.7-4.1 4.7-1 2.1-1.5 4.5-1.5 7.1 0 2.7.5 5.2 1.5 7.3s2.3 3.6 4.1 4.7c1.7 1.1 3.6 1.7 5.8 1.7 2.3 0 4.2-.5 6-1.7 1.8-1.1 3.1-2.7 4.1-4.7 1-2.1 1.5-4.5 1.5-7.2s-.5-5.1-1.5-7.2c-1-2-2.4-3.6-4.1-4.7-1.8-1.2-3.8-1.7-6-1.7zm-44.4 35.7c-1 0-1.9-.7-2.2-1.6l-7.5-23.6-8.1 23.7c-.3.9-1.2 1.6-2.2 1.6h-5.8c-1 0-1.9-.6-2.2-1.6l-13-39.6c-.3-1 .1-2.2 1-2.7.4-.2.8-.3 1.3-.3h6c1 0 1.9.6 2.2 1.6l7.9 24.6 8.1-24.7c.3-1 1.2-1.6 2.2-1.6h5.6c1 0 1.9.7 2.2 1.6l7.8 24.4 7.8-24.4c.3-1 1.2-1.6 2.2-1.6h5.5c.3 0 .6 0 .9.2 1.2.5 1.7 1.8 1.3 2.9l-12.8 39.5c-.3 1-1.2 1.6-2.2 1.6zm-100.4-.2c-1.3 0-2.3-1-2.3-2.3v-59c0-1.3 1-2.3 2.3-2.3h5.8c1.3 0 2.3 1 2.3 2.3v59c0 1.3-1 2.3-2.3 2.3zm-31.7 1.5c-4.2 0-8-1-11.4-3-3.3-2-6-4.9-7.9-8.4s-2.8-7.6-2.8-12.1c0-4.4.9-8.4 2.8-11.9s4.5-6.4 7.8-8.4 7.1-3 11.3-3c3.2 0 6.3.7 9 2.2.9.5 1.8 1 2.6 1.7v-.2c0-1.3 1-2.3 2.3-2.3h5.8c1.3 0 2.3 1 2.3 2.3v39.6c0 1.3-1 2.3-2.3 2.3h-5.7c-1.3 0-2.3-1-2.3-2.3v-.1c-.8.6-1.7 1.2-2.6 1.6-2.7 1.3-5.7 2-8.9 2zm-.1-37c-2.2 0-4.1.5-5.8 1.7-1.7 1.1-3.1 2.7-4.1 4.7-1 2.1-1.5 4.5-1.5 7.1 0 2.7.5 5.2 1.5 7.3s2.3 3.6 4.1 4.7c1.7 1.1 3.6 1.7 5.8 1.7 2.3 0 4.2-.5 6-1.7 1.8-1.1 3.1-2.7 4.1-4.7 1-2.1 1.5-4.5 1.5-7.2s-.5-5.1-1.5-7.2c-1-2-2.4-3.6-4.1-4.7-1.8-1.2-3.8-1.7-6-1.7zm-42.8 37c-4.2 0-8.1-1-11.4-3s-6-4.9-7.9-8.4-2.8-7.6-2.8-12 .9-8.4 2.8-12 4.5-6.4 7.8-8.4 7.2-3 11.4-3c3.6 0 6.8.8 9.6 2.4 2.6 1.5 5.1 3.7 7.2 6.5.8 1 .6 2.5-.4 3.3l-4.2 3.3c-.4.3-.9.5-1.4.5h-.4c-.6-.1-1.2-.5-1.6-1-2.3-3.4-5.2-5-8.8-5-2.2 0-4.1.5-5.9 1.7-1.7 1.1-3.1 2.7-4.1 4.7-1 2.1-1.5 4.5-1.5 7.2s.5 5.1 1.5 7.2 2.3 3.6 4.1 4.7c1.7 1.1 3.7 1.7 5.9 1.7 2.3 0 4.2-.4 5.6-1.1 1.5-.8 2.8-1.9 4-3.5.4-.6 1.1-.9 1.8-.9.5 0 .9.1 1.3.4l4.5 3.1c.5.4.9.9 1 1.6.1.6-.1 1.3-.5 1.8-2.1 2.6-4.6 4.6-7.7 6.2-3.1 1.2-6.4 2-9.9 2zm-49.5-.2c-4.6 0-9.1-1.2-13.4-3.4-4.3-2.3-7.9-5.4-10.8-9.3-.7-1-.6-2.3.3-3.1l5.2-4.6c.4-.4 1-.6 1.5-.6h.3c.7.1 1.3.5 1.6 1.1 1.8 2.9 4.2 5.2 7 6.9s5.8 2.5 9 2.5c3.4 0 6-.7 7.6-2.1 1.6-1.3 2.3-3.1 2.3-5.5 0-2.6-.8-4.5-2.5-5.8-2-1.6-5.3-3-9.8-4.3-13.3-3.3-20-9.6-20-18.8 0-5.7 1.9-10.2 5.7-13.4 3.7-3 8.8-4.6 15.1-4.6 4.6 0 8.7.9 12.4 2.6s7 4.4 9.8 7.9c.8 1 .7 2.4-.3 3.2l-5 4.2c-.4.4-1 .6-1.5.6h-.3c-.6-.1-1.2-.4-1.6-.9-1.8-2.5-3.8-4.3-5.9-5.5-2.1-1.1-4.6-1.7-7.6-1.7s-5.5.7-7.3 2c-1.6 1.2-2.4 2.8-2.4 4.9 0 2.2.7 3.9 2.3 5.2 1.8 1.5 5 2.8 9.6 3.9 6.2 1.7 11.1 4 14.6 7 3.8 3.2 5.7 7.7 5.7 13.4 0 3.6-.9 6.7-2.8 9.5-1.8 2.7-4.4 4.9-7.8 6.4-2.9 1.5-6.7 2.3-11 2.3zm166.2-225.1c19.2 0 34.9 15.7 34.9 34.9v67.1c-.8 4.6-4.5 8.2-9.2 8.8h-44.6c-19.3 0-34.9-15.6-34.9-34.9v-65.1c0-6 4.8-10.8 10.8-10.8h43m0-16.4h-43.1c-15 0-27.2 12.2-27.2 27.2v65.1c0 28.3 23 51.3 51.3 51.3h45.4c13-1.1 23.5-11.3 24.8-24.2v-68.1c.1-28.4-22.8-51.3-51.2-51.3zm-4 32.9h-23.7c-5.2.6-9.2 4.9-9.4 10.1v34.2c0 2.3.9 4.3 2.4 5.8s3.5 2.4 5.8 2.4c4.5 0 8.2-3.7 8.2-8.2v-21.7c0-3.4 2.8-6.2 6.2-6.2h10.7c2.3 0 4.3-.9 5.8-2.4s2.4-3.6 2.4-5.9c0-4.5-3.9-8.1-8.4-8.1zm-10.7 78h23.7c5.2-.6 9.2-4.9 9.4-10.1v-34.2c0-2.3-.9-4.3-2.4-5.8s-3.5-2.4-5.8-2.4c-4.5 0-8.2 3.7-8.2 8.2v21.7c0 3.4-2.8 6.2-6.2 6.2h-10.7c-2.3 0-4.3.9-5.8 2.4s-2.4 3.6-2.4 5.9c.1 4.5 3.9 8.1 8.4 8.1z" fill="%234f0599"/%3E%3C/svg%3E'],
  ['app:kubernetes', 'https://i.imgur.com/w02gE4N.png'],
  ['app:notion', 'data:image/svg+xml,%3Csvg width="800" height="600" version="1.1" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg"%3E%3Cg transform="translate(0,28)"%3E%3Cpath d="m253.56 15.092 193.67-14.294c23.783-2.0444 29.902-.675 44.85 10.208l61.821 43.548c10.201 7.4886 13.601 9.5274 13.601 17.691v238.85c0 14.969-5.441 23.822-24.463 25.176l-224.91 13.612c-14.279.682-21.075-1.357-28.553-10.89l-45.526-59.2c-8.1578-10.897-11.55-19.049-11.55-28.588v-212.3c0-12.241 5.4422-22.452 21.059-23.807z" fill="%23fff"/%3E%3Cpath d="m447.23.7982-193.67 14.294c-15.616 1.3555-21.059 11.566-21.059 23.807v212.3c0 9.539 3.3923 17.691 11.55 28.588l45.526 59.2c7.478 9.533 14.274 11.572 28.553 10.89l224.91-13.612c19.022-1.354 24.463-10.207 24.463-25.176v-238.85c0-7.7378-3.055-9.973-12.06-16.562-.49598-.3625-1.009-.7382-1.541-1.1287l-61.821-43.548c-14.948-10.883-21.067-12.252-44.85-10.208zm-124 67.53c-18.361 1.2427-22.533 1.525-32.96-6.9652l-26.516-21.094c-2.7044-2.7277-1.348-6.1302 5.4417-6.8051l186.18-13.611c15.624-1.3639 23.776 4.0887 29.895 8.8497l31.932 23.138c1.36.6776 4.751 4.7553.673 4.7553l-192.27 11.572c-.802.0536-1.578.1061-2.331.1571l-.026.002zm-21.416 240.72v-202.77c0-8.844 2.718-12.93 10.867-13.617l220.82-12.924c7.49-.68 10.882 4.086 10.882 12.924v201.41c0 8.852-1.363 16.348-13.598 17.022l-211.31 12.255c-12.229.674-17.662-3.402-17.662-14.3zm208.6-191.9c1.355 6.13 0 12.255-6.127 12.944l-10.182 2.033v149.7c-8.839 4.762-16.991 7.485-23.784 7.485-10.875 0-13.599-3.405-21.745-13.606l-66.597-104.79v101.39l21.074 4.767s0 12.242-17.002 12.242l-46.872 2.725c-1.362-2.725 0-9.524 4.754-10.887l12.232-3.397v-134.05l-16.983-1.364c-1.362-6.13 2.03-14.969 11.549-15.655l50.283-3.397 69.307 106.15v-93.908l-17.67-2.033c-1.357-7.494 4.071-12.935 10.867-13.61z" clip-rule="evenodd" fill="%23000" fill-rule="evenodd"/%3E%3C/g%3E%3Cpath d="m584.21 564.09h23.308v-59.868c0-15.132 8.741-24.718 22.65-24.718 14.193 0 20.773 7.895 20.773 23.59v60.996h23.31v-66.541c0-24.53-12.5-38.346-35.436-38.346-15.32 0-25.658 7.049-30.545 18.515h-1.598v-16.447h-22.462zm-63.309 2.068c30.733 0 49.436-20.113 49.436-53.477 0-33.271-18.797-53.478-49.436-53.478-30.545 0-49.436 20.301-49.436 53.478 0 33.364 18.609 53.477 49.436 53.477zm0-19.549c-16.259 0-25.564-12.406-25.564-33.928 0-21.429 9.305-33.929 25.564-33.929 16.166 0 25.47 12.5 25.47 33.929 0 21.522-9.21 33.928-25.47 33.928zm-86.898 17.481h23.214v-102.82h-23.214zm11.56-119.83c7.707 0 13.91-6.203 13.91-14.004s-6.203-14.098-13.91-14.098c-7.613 0-13.91 6.297-13.91 14.098s6.297 14.004 13.91 14.004zm-70.733-8.177v25.846h-16.259v18.609h16.259v56.109c0 19.925 9.398 27.913 32.989 27.913 4.511 0 8.834-.47 12.218-1.128v-18.233c-2.82.282-4.606.47-7.895.47-9.774 0-14.098-4.511-14.098-14.661v-50.47h21.993v-18.609h-21.993v-25.846zm-70.733 130.08c30.733 0 49.436-20.113 49.436-53.477 0-33.271-18.797-53.478-49.436-53.478-30.545 0-49.436 20.301-49.436 53.478 0 33.364 18.609 53.477 49.436 53.477zm0-19.549c-16.26 0-25.564-12.406-25.564-33.928 0-21.429 9.304-33.929 25.564-33.929 16.165 0 25.47 12.5 25.47 33.929 0 21.522-9.211 33.928-25.47 33.928zm-154.94 17.481v-92.293h1.598l66.541 92.293h20.959v-135.62h-23.308v92.199h-1.598l-66.541-92.199h-21.053v135.62z" fill="%23000"/%3E%3C/svg%3E'],
]);
      // }, {
      //   id: 'bundled:kubernetes',
      //   url: 'bundled:'+encodeURIComponent('app:kubernetes'),
      //   title: 'Kubernetes Client',
      //   description: 'Provides access to Kubernetes cluster resources',
      //   iconUrl: 'https://i.imgur.com/w02gE4N.png',
      // },  {
      //   id: 'bundled:notion',
      //   url: 'bundled:'+encodeURIComponent('app:notion'),
      //   title: 'Notion Developer API',
      //   description: 'Provides access to Kubernetes cluster resources',
      //   iconUrl: '',
      // };

      // this.listings = [{
      //   id: 'bundled:scaleway',
      //   url: 'bundled:'+encodeURIComponent('app:scaleway'),
      //   // url: 'https://dist.app/bin/scaleway@v1alpha1.yaml',
      //   // url: 'https://gist.githubusercontent.com/danopia/cd69add8cbbd7e5ff7603b8f3d372f26/raw/a8091b594fe961d9e637d2a6037e276b01c1d15f/scaleway.yaml',
      //   title: 'Scaleway Instances Remote',
      //   description: 'Toggle Scaleway servers on/off',
      //   iconUrl: 'https://cdn.european-alternatives.eu/productLogo/342ca056-82e4-45b7-9710-9dc5b72dfaa9/Scaleway-Logo-Purple-RGB.svg',
      // }, {
      //   id: 'bundled:kubernetes',
      //   url: 'bundled:'+encodeURIComponent('app:kubernetes'),
      //   title: 'Kubernetes Client',
      //   description: 'Provides access to Kubernetes cluster resources',
      //   iconUrl: 'https://i.imgur.com/w02gE4N.png',
      // },  {
      //   id: 'bundled:notion',
      //   url: 'bundled:'+encodeURIComponent('app:notion'),
      //   title: 'Notion Developer API',
      //   description: 'Provides access to Kubernetes cluster resources',
      //   iconUrl: 'data:image/svg+xml,%3Csvg width="800" height="600" fill="none" version="1.1" viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg"%3E%3Cg transform="translate(0,28)"%3E%3Cpath d="m253.56 15.092 193.67-14.294c23.783-2.0444 29.902-.675 44.85 10.208l61.821 43.548c10.201 7.4886 13.601 9.5274 13.601 17.691v238.85c0 14.969-5.441 23.822-24.463 25.176l-224.91 13.612c-14.279.682-21.075-1.357-28.553-10.89l-45.526-59.2c-8.1578-10.897-11.55-19.049-11.55-28.588v-212.3c0-12.241 5.4422-22.452 21.059-23.807z" fill="%23fff"/%3E%3Cpath d="m447.23.7982-193.67 14.294c-15.616 1.3555-21.059 11.566-21.059 23.807v212.3c0 9.539 3.3923 17.691 11.55 28.588l45.526 59.2c7.478 9.533 14.274 11.572 28.553 10.89l224.91-13.612c19.022-1.354 24.463-10.207 24.463-25.176v-238.85c0-7.7378-3.055-9.973-12.06-16.562-.49598-.3625-1.009-.7382-1.541-1.1287l-61.821-43.548c-14.948-10.883-21.067-12.252-44.85-10.208zm-124 67.53c-18.361 1.2427-22.533 1.525-32.96-6.9652l-26.516-21.094c-2.7044-2.7277-1.348-6.1302 5.4417-6.8051l186.18-13.611c15.624-1.3639 23.776 4.0887 29.895 8.8497l31.932 23.138c1.36.6776 4.751 4.7553.673 4.7553l-192.27 11.572c-.802.0536-1.578.1061-2.331.1571l-.026.002zm-21.416 240.72v-202.77c0-8.844 2.718-12.93 10.867-13.617l220.82-12.924c7.49-.68 10.882 4.086 10.882 12.924v201.41c0 8.852-1.363 16.348-13.598 17.022l-211.31 12.255c-12.229.674-17.662-3.402-17.662-14.3zm208.6-191.9c1.355 6.13 0 12.255-6.127 12.944l-10.182 2.033v149.7c-8.839 4.762-16.991 7.485-23.784 7.485-10.875 0-13.599-3.405-21.745-13.606l-66.597-104.79v101.39l21.074 4.767s0 12.242-17.002 12.242l-46.872 2.725c-1.362-2.725 0-9.524 4.754-10.887l12.232-3.397v-134.05l-16.983-1.364c-1.362-6.13 2.03-14.969 11.549-15.655l50.283-3.397 69.307 106.15v-93.908l-17.67-2.033c-1.357-7.494 4.071-12.935 10.867-13.61z" clip-rule="evenodd" fill="%23000" fill-rule="evenodd"/%3E%3C/g%3E%3Cpath d="m584.21 564.09h23.308v-59.868c0-15.132 8.741-24.718 22.65-24.718 14.193 0 20.773 7.895 20.773 23.59v60.996h23.31v-66.541c0-24.53-12.5-38.346-35.436-38.346-15.32 0-25.658 7.049-30.545 18.515h-1.598v-16.447h-22.462zm-63.309 2.068c30.733 0 49.436-20.113 49.436-53.477 0-33.271-18.797-53.478-49.436-53.478-30.545 0-49.436 20.301-49.436 53.478 0 33.364 18.609 53.477 49.436 53.477zm0-19.549c-16.259 0-25.564-12.406-25.564-33.928 0-21.429 9.305-33.929 25.564-33.929 16.166 0 25.47 12.5 25.47 33.929 0 21.522-9.21 33.928-25.47 33.928zm-86.898 17.481h23.214v-102.82h-23.214zm11.56-119.83c7.707 0 13.91-6.203 13.91-14.004s-6.203-14.098-13.91-14.098c-7.613 0-13.91 6.297-13.91 14.098s6.297 14.004 13.91 14.004zm-70.733-8.177v25.846h-16.259v18.609h16.259v56.109c0 19.925 9.398 27.913 32.989 27.913 4.511 0 8.834-.47 12.218-1.128v-18.233c-2.82.282-4.606.47-7.895.47-9.774 0-14.098-4.511-14.098-14.661v-50.47h21.993v-18.609h-21.993v-25.846zm-70.733 130.08c30.733 0 49.436-20.113 49.436-53.477 0-33.271-18.797-53.478-49.436-53.478-30.545 0-49.436 20.301-49.436 53.478 0 33.364 18.609 53.477 49.436 53.477zm0-19.549c-16.26 0-25.564-12.406-25.564-33.928 0-21.429 9.304-33.929 25.564-33.929 16.165 0 25.47 12.5 25.47 33.929 0 21.522-9.211 33.928-25.47 33.928zm-154.94 17.481v-92.293h1.598l66.541 92.293h20.959v-135.62h-23.308v92.199h-1.598l-66.541-92.199h-21.053v135.62z" fill="%23000"/%3E%3C/svg%3E',
      // };
